## typeorm ì—ì„œ trie ë¦´ë ˆì´ì…˜ í‘œí˜„í•˜ê¸°

### ê°€ì •ëœ ìƒí™© ì˜ˆì‹œ

- ê³µìœ  ë…¸íŠ¸ ì–´í”Œë¦¬ì¼€ì´ì…˜
- ì‚¬ìš©ìëŠ” nê°œì˜ ë…¸íŠ¸ë¥¼ ê°€ì§„ë‹¤.
- ì‚¬ìš©ìëŠ” nê°œì˜ ë…¸íŠ¸ë¥¼ ê³µìœ  ë°›ì„ ìˆ˜ ìˆë‹¤.
- ë˜í•œ nê°œì˜ ë…¸íŠ¸ë¥¼ ê³µìœ í•  ìˆ˜ ìˆë‹¤.

### ì—”í„°í‹°

1. User
2. Note
3. SharedNote (trie mapping table )

### ê´€ê³„ ëª¨ë¸ë§

1. User-Note ëŠ” 1:N ê´€ê³„ì´ë‹¤.
2. íŠ¸ë¼ì´ ê´€ê³„

- User-SharedNote ëŠ” 1:Nê´€ê³„ (Aê°€ ê³µìœ í•œ)
- User-SharedNote ëŠ” 1:Nê´€ê³„ (Bê°€ ê³µìœ ë°›ì€)
- Note-SharedNote ëŠ” 1:Nê´€ê³„ (Cë¼ëŠ” ë…¸íŠ¸ë¥¼)

### user.entity.ts

```ts
import { Column, Entity, OneToMany, PrimaryGeneratedColumn } from 'typeorm';
import { Note } from './note.entity';
import { SharedNote } from './sharedNote.entity';

@Entity()
export class User {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  username: string;

  @OneToMany(() => Note, (note) => note.owner)
  notes: Note;

  @OneToMany(() => SharedNote, (sharedNote) => sharedNote.target)
  notesYouShare: SharedNote[];

  @OneToMany(() => SharedNote, (sharedNote) => sharedNote.sender)
  notesSharedWithYou: SharedNote[];
}

export type UserRelation =
  | keyof Pick<User, 'notes' | 'notesSharedWithYou' | 'notesYouShare'>
  | 'notesSharedWithYou.note'
  | 'notesYouShare.note';

// export type nnn = '1' | '2';
// export type eee = 'ğŸš€' | 'âœ”';
// export type nnneee = `${nnn}-${eee}-${UserRelation}`;
```

### note.entity.ts

```ts
import {
  Column,
  Entity,
  JoinColumn,
  ManyToOne,
  OneToMany,
  PrimaryGeneratedColumn,
} from 'typeorm';
import { SharedNote } from './sharedNote.entity';
import { User } from './user.entity';

@Entity()
export class Note {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  text: string;

  @Column()
  ownerId: number;

  @ManyToOne(() => User, (user) => user.notes)
  @JoinColumn({ name: 'ownerId' })
  owner: User;

  @OneToMany(() => SharedNote, (sharedNote) => sharedNote.note)
  shares: SharedNote;
}
```

### sharedNote.entity.ts

```ts
import { Entity, JoinColumn, ManyToOne, PrimaryColumn } from 'typeorm';
import { Note } from './note.entity';
import { User } from './user.entity';

@Entity()
export class SharedNote {
  @PrimaryColumn()
  senderId: number;

  @ManyToOne(() => User, (user) => user.notesSharedWithYou)
  @JoinColumn({ name: 'senderId' })
  sender: User;

  @PrimaryColumn()
  targetId: number;

  @ManyToOne(() => User, (user) => user.notesYouShare)
  @JoinColumn({ name: 'targetId' })
  target: User;

  @PrimaryColumn()
  noteId: number;

  @ManyToOne(() => Note, (note) => note.shares)
  @JoinColumn({ name: 'noteId' })
  note: Note;
}
```

### CRUD

- âœ” ë‹¨ì¼ê°ì²´ì—ì„œ CRUD
- 1:N ê´€ê³„ë¥¼ ê°€ì§€ëŠ” ì‚¬ìš©ìì™€ notes ê°„ì— CRUD

1. ì‚¬ìš©ì id ë§Œìœ¼ë¡œ ë§¤í•‘ì´ ë˜ì–´ì•¼ í•œë‹¤.
2. ì‚¬ìš©ì ê°ì²´ë¥¼ ì´ìš©í•´ ë§¤í•‘ì´ ë˜ì–´ì•¼ í•œë‹¤.

- N:M ê´€ê³„ë¥¼ ê°€ì§€ëŠ” ì‚¬ìš©ìì™€ ë…¸íŠ¸ ê³µìœ ì ê°„ì— CURD

1. 2ëª…ì˜ ì‚¬ìš©ì id ë§Œìœ¼ë¡œ ë§¤í•‘ì´ ë˜ì–´ì•¼ í•œë‹¤.
2. 2ëª…ì˜ ì‚¬ìš©ì ê°ì²´ë¥¼ ì´ìš©í•´ ë§¤í•‘ì´ ë˜ì–´ì•¼ í•œë‹¤.
3. sharedNote ê°ì²´ ì…ì¥ì—ì„œ, ì‚¬ìš©ìë¥¼ 1step joiní•´ì•¼í•œë‹¤.
4. ì‚¬ìš©ì ì…ì¥ì—ì„œ, ë§¤í•‘í…Œì´ë¸”ì„ ì´ìš©í•´ ë…¸íŠ¸ê¹Œì§€ 2step join í•´ì•¼í•œë‹¤.

```ts
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Like, Repository } from 'typeorm';
import { Note } from './entities/note.entity';
import { SharedNote } from './entities/sharedNote.entity';
import { User, UserRelation } from './entities/user.entity';

@Injectable()
export class UserService {
  constructor(
    @InjectRepository(User)
    private readonly userRepo: Repository<User>,
    @InjectRepository(Note)
    private readonly noteRepo: Repository<Note>,
    @InjectRepository(SharedNote)
    private readonly sharedNoteRepo: Repository<SharedNote>,
  ) {
    const test = async () => {
      // CRUD user
      // const user = await userRepo.save(userRepo.create({ username: 'user_dodo' }));
      // console.log(user);
      // const user1 = await userRepo.findOne({ where: { id: 1 } });
      // console.log(user1);
      // user1.username = 'user1-1';
      // await userRepo.save(user1);
      // user1.username = 'user1-2';
      // await userRepo.save(user1);
      // user1.username = 'user1-3';
      // await userRepo.save([user1]);
      // user1.username = 'user1-4';
      // await userRepo.save([{ ...user1 }]);
      // await userRepo.save([{ ...user1 }, { ...user1 }]);
      // CRUD user-note
      // const note1 = await noteRepo.save(
      //   noteRepo.create({ text: 'hello world', ownerId: 1 }),
      // );
      // const user = await userRepo.findOne(1);
      // console.log(
      //   await userRepo.findOne({ where: { id: 1 }, relations: ['notes'] }),
      // );
      // const note2 = await noteRepo.save(
      //   noteRepo.create({ text: 'hello world', owner: user }),
      // );
      // const note3 = await noteRepo.find({
      //   where: { ownerId: user.id },
      //   relations: ['owner'],
      // });
      // console.log(note3);
      // CRUD user-shared-note
      const dodo = await userRepo.findOne({
        where: { username: Like('%do%') },
      });
      // console.log(dodo);
      const nana = await userRepo.findOne({
        where: { username: Like('%nana%') },
      });
      // console.log(nana);
      const dodosNote1 = await noteRepo.findOne({
        where: { ownerId: nana.id, text: Like('%1%') },
      });
      // console.log(dodosNote1);

      // nana > dodo  note shared
      // const sharedMap = await sharedNoteRepo.save(
      //   sharedNoteRepo.create({
      //     sender: nana,
      //     target: dodo,
      //     note: dodosNote1,
      //   }),
      // );
      // console.log(sharedMap);

      // read relation mapping table
      const NotesNanaShare = await sharedNoteRepo.find({
        where: { sender: nana },
        relations: ['sender', 'target', 'note'],
      });
      // console.log(NotesNanaShare);

      // read relation user - mapping table - note
      const dodoUser = await userRepo.findOne({
        where: { username: Like('%nana%') },
        relations: [
          'notes',
          'notesSharedWithYou', // 1
          'notesSharedWithYou.note', // 2
          // 'notesYouShare',
          // 'notesYouShare.note',
        ] as UserRelation[],
      });
      console.log(JSON.stringify(dodoUser, null, 4));
    };
    test();
  }
}
```
